<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XLVI CILAMCE - Full Program</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --card: #111827;
      --ink: #e5e7eb;
      --muted: #9ca3af;
      --brand: #60a5fa;
      --accent: #22d3ee;
      --line: #1f2937;
      --chip: #1e293b;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;
      color: var(--ink); background: radial-gradient(1200px 600px at 10% -10%, #12223f 0%, transparent 60%), var(--bg);
      display: grid; grid-template-rows: auto 1fr;
    }
    header {
      background: linear-gradient(90deg, rgba(96,165,250,.15), rgba(34,211,238,.15));
      border-bottom: 1px solid var(--line);
      padding: 14px 18px;
      display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    }
    header h1 { margin: 0; font-size: 18px; letter-spacing: .3px; }
    .badge { font-size: 12px; color: var(--muted); }
    .datasource { color: var(--accent); font-weight: 600; }

    .layout { display: grid; grid-template-columns: 300px 1fr; min-height: 0; }
    aside { background: var(--panel); border-right: 1px solid var(--line); padding: 16px; overflow: auto; }
    main { padding: 18px; overflow: auto; }

    .filters h2 { font-size: 13px; margin: 0 0 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .12em; }
    .filter-group { margin-bottom: 14px; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], select {
      width: 100%; padding: 10px 12px; border: 1px solid var(--line); border-radius: 10px; background: #0b1220; color: var(--ink);
    }

    .toolbar { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    .btn { border: 1px solid var(--line); background: #0b1220; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-size: 14px; color: var(--ink); }
    .btn.primary { background: var(--brand); color: #0b1220; border-color: transparent; font-weight: 700; }
    .btn.ghost { background: transparent; }
    .view-switch { margin-left: auto; }

    .day-group { margin: 18px 0 30px; }
    .day-title { font-size: 18px; font-weight: 800; margin: 8px 0 8px; color: #dbeafe; }
    .slot-title { font-size: 14px; font-weight: 700; margin: 10px 0 8px; color: #93c5fd; letter-spacing: .02em; }
    .session-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }

    .card {
      background: linear-gradient(180deg, rgba(96,165,250,.08), rgba(34,211,238,.06));
      border: 1px solid var(--line); border-radius: 16px; padding: 14px; display: flex; flex-direction: column; gap: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,.24);
    }
    .card h3 { margin: 0; font-size: 16px; }
    .meta { color: var(--muted); font-size: 13px; }
    .papers { margin-top: 6px; border-top: 1px dashed var(--line); padding-top: 8px; }
    .paper { padding: 8px 0; }
    .paper-title { font-weight: 600; }
    .paper-auth { color: var(--muted); font-size: 13px; }
    .paper-abs { margin-top: 4px; font-size: 14px; color: #e5e7eb; }
    details summary { cursor: pointer; }

    .tag { font-size: 12px; background: var(--chip); color: #a5b4fc; padding: 2px 8px; border-radius: 999px; margin-left: 8px; border: 1px solid #334155; }
    .empty { padding: 24px; text-align: center; color: var(--muted); border: 1px dashed var(--line); border-radius: 12px; background: #0b1220; }
    .subtle { color: var(--muted); font-size: 13px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas; background: #0b1220; border: 1px solid var(--line); border-bottom-width: 2px; padding: 1px 6px; border-radius: 6px; font-size: 12px; color: var(--ink); }
    .footer-note { color: var(--muted); font-size: 12px; margin-top: 8px; }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      aside { position: sticky; top: 0; z-index: 5; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Conference Program</h1>
    <div class="badge">Program Version: <span id="datasource" class="datasource">—</span></div>
  </header>

  <div class="layout">
    <aside>
      <div class="filters">
        <h2>Filters</h2>
        <div class="filter-group">
          <label for="q">Search by title or author</label>
          <input id="q" type="text" placeholder="E.g. John Doe; Numerical Analusis" />
        </div>
        <div class="filter-group">
          <label for="day">Day</label>
          <select id="day"><option value="">All</option></select>
        </div>
        <div class="filter-group">
          <label for="room">Room</label>
          <select id="room"><option value="">All</option></select>
        </div>
        <div class="filter-group">
          <label for="time">Time</label>
          <select id="time"><option value="">All</option></select>
        </div>
        <div class="filter-group">
          <label for="track">Mini-Symposia</label>
          <select id="track"><option value="">All</option></select>
        </div>
        <div class="toolbar">
          <button class="btn" id="clear">Clear filters</button>
          <button class="btn" id="expandAll">Expand all</button>
          <button class="btn" id="collapseAll">Retract all</button>
        </div>
        <div class="footer-note">Tip: use <span class="kbd">Ctrl</span>+<span class="kbd">F</span> to find information quickly.</div>
      </div>
    </aside>

    <main>
      <div class="toolbar">
        <div class="subtle">Viewing <span id="count">0</span> sessions</div>
        <div class="view-switch">
          <button class="btn ghost" id="viewByDay">By day</button>
          <button class="btn ghost" id="viewByRoom">By room</button>
        </div>
      </div>
      <div id="container"></div>
    </main>
  </div>

  <script>
  const state = {
    sessions: [],
    view: 'day',
    filters: { q: '', day: '', room: '', track: '', time: '' }
  };

  function setSource(src) {
    const el = document.getElementById('datasource');
    if (el) el.textContent = src;
  }

  async function loadData() {
    const fixed = 'https://joaovfdias.github.io/programa-cilamce/program.json';
    const relative = './program.json';

    async function tryFetch(url, label) {
      const res = await fetch(url + '?ts=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status + ' em ' + url);
      const text = await res.text();
      if (text.trim().startsWith('<')) throw new Error('Resposta HTML (prov. 404) em ' + url);
      const data = JSON.parse(text);
      setSource(label);
      return data;
    }

    try {
      state.sessions = await tryFetch(fixed, 'JSON fixo (GitHub Pages)');
    } catch (e1) {
      console.warn('[fetch fixed] falhou:', e1);
      try {
        state.sessions = await tryFetch(relative, 'JSON relativo (./program.json)');
      } catch (e2) {
        console.error('[fetch relative] falhou também:', e2);
        const ctn = document.getElementById('container');
        if (ctn) {
          ctn.innerHTML =
            '<div class="empty">' +
              'Não foi possível carregar os dados.<br/>' +
              '<small>' + String((e2 && e2.message) || e2) + '</small>' +
            '</div>';
        }
        setSource('—');
        return;
      }
    }

    hydrateFilters();
    render();
  }

  function hydrateFilters() {
    const unique = (arr) => Array.from(new Set(arr)).sort();
    const days = unique(state.sessions.map((s) => s.day));
    const rooms = unique(state.sessions.map((s) => s.room));
    const tracks = unique(state.sessions.map((s) => s.track));
    const times = unique(state.sessions.map((s) => (s.time_start + '-' + s.time_end)));
    fillSelect('day', days);
    fillSelect('room', rooms);
    fillSelect('track', tracks);
    fillSelect('time', times);
  }

  function fillSelect(id, options) {
    const sel = document.getElementById(id);
    if (!sel) return;
    Array.from(sel.querySelectorAll('option:not(:first-child)')).forEach((o) => o.remove());
    options.forEach((v) => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    });
  }

  function applyFilters(session) {
    const f = state.filters;
    if (f.day && session.day !== f.day) return false;
    if (f.room && session.room !== f.room) return false;
    if (f.track && session.track !== f.track) return false;
    if (f.time && (session.time_start + '-' + session.time_end) !== f.time) return false;
    if (f.q) {
      const hay = [
        session.title,
        session.track,
        session.room,
        session.chair || '',
        session.time_start + '-' + session.time_end,
        (session.papers || []).map((p) => [p.title, p.authors, p.abstract].join(' ')).join(' ')
      ].join(' ').toLowerCase();
      if (!hay.includes(f.q.toLowerCase())) return false;
    }
    return true;
  }

  function groupBy(arr, keyFn) {
    const acc = {};
    for (const item of arr) {
      const k = keyFn(item);
      if (!acc[k]) acc[k] = [];
      acc[k].push(item);
    }
    return acc;
  }

  function render() {
    const container = document.getElementById('container');
    if (!container) return;
    container.innerHTML = '';

    const filtered = state.sessions.filter(applyFilters);
    const countEl = document.getElementById('count');
    if (countEl) countEl.textContent = String(filtered.length);

    if (!filtered.length) {
      container.innerHTML = '<div class="empty">No session with the current filters.</div>';
      return;
    }

    if (state.view === 'day') {
      const byDay = groupBy(filtered, (s) => s.day);
      Object.keys(byDay).sort().forEach((day) => {
        const group = document.createElement('section');
        group.className = 'day-group';

        const title = document.createElement('div');
        title.className = 'day-title';
        title.textContent = formatDay(day);
        group.appendChild(title);

        const bySlot = groupBy(byDay[day], (s) => s.time_start + '-' + s.time_end);
        const slots = Object.keys(bySlot).sort();
        for (const slot of slots) {
          const parts = slot.split('-');
          const ts = parts[0] || '';
          const te = parts[1] || '';

          const slotTitle = document.createElement('div');
          slotTitle.className = 'slot-title';
          slotTitle.textContent = fmtTime(ts) + ' – ' + fmtTime(te);
          group.appendChild(slotTitle);

          const grid = document.createElement('div');
          grid.className = 'session-grid';
          bySlot[slot]
            .sort((a, b) => a.room.localeCompare(b.room))
            .forEach((s) => grid.appendChild(sessionCard(s)));
          group.appendChild(grid);
        }

        container.appendChild(group);
      });
    } else {
      const byRoom = groupBy(filtered, (s) => s.room);
      Object.keys(byRoom).sort().forEach((room) => {
        const group = document.createElement('section');
        group.className = 'day-group';

        const title = document.createElement('div');
        title.className = 'day-title';
        title.textContent = room;
        group.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'session-grid';
        byRoom[room]
          .sort((a, b) => (a.day === b.day ? a.time_start.localeCompare(b.time_start) : a.day.localeCompare(b.day)))
          .forEach((s) => grid.appendChild(sessionCard(s)));
        group.appendChild(grid);

        container.appendChild(group);
      });
    }
  }

  function sessionCard(s) {
    const el = document.createElement('article');
    el.className = 'card';

    const h3 = document.createElement('h3');
    h3.textContent = s.title || '';

    const tag = document.createElement('span');
    tag.className = 'tag';
    tag.textContent = s.track || '';
    h3.appendChild(tag);

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent =
      fmtTime(s.time_start) + '–' + fmtTime(s.time_end) + ' · ' + (s.room || '') + (s.chair ? ' · Coord.: ' + s.chair : '');

    const papers = document.createElement('div');
    papers.className = 'papers';

    (s.papers || []).forEach((p) => {
      const details = document.createElement('details');
      const summary = document.createElement('summary');
      summary.innerHTML =
        '<span class="paper-title">' + escapeHtml(p.title || '') + '</span>' +
        '<div class="paper-auth">' + escapeHtml(p.authors || '') + '</div>';
      const abs = document.createElement('div');
      abs.className = 'paper-abs';
      abs.textContent = p.abstract || '';
      details.appendChild(summary);
      details.appendChild(abs);
      papers.appendChild(details);
    });

    el.appendChild(h3);
    el.appendChild(meta);
    el.appendChild(papers);
    return el;
  }

  function formatDay(d) {
    if (!/^\d{4}-\d{2}-\d{2}$/.test(String(d || ''))) return d || '';
    const parts = String(d).split('-').map(Number);
    const date = new Date(parts[0], parts[1] - 1, parts[2]);
    return date.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  }

  function fmtTime(t) {
    const s = String(t || '');
    if (s.length >= 5) return s.slice(0, 5).replace(':', 'h');
    return s.replace(':', 'h');
  }

  function escapeHtml(str) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
    return String(str).replace(/[&<>\"']/g, function (ch) { return map[ch] || ch; });
  }

  document.addEventListener('input', function (e) {
    const id = e.target && e.target.id;
    if (id === 'q')   { state.filters.q   = e.target.value; render(); }
    if (id === 'day') { state.filters.day = e.target.value; render(); }
    if (id === 'room'){ state.filters.room= e.target.value; render(); }
    if (id === 'track'){state.filters.track= e.target.value; render(); }
    if (id === 'time'){ state.filters.time= e.target.value; render(); }
  });

  document.addEventListener('click', function (e) {
    const id = e.target && e.target.id;
    if (id === 'clear') {
      state.filters = { q: '', day: '', room: '', track: '', time: '' };
      ['q','day','room','track','time'].forEach(function (x) {
        var el = document.getElementById(x);
        if (el) el.value = '';
      });
      render();
    }
    if (id === 'expandAll') { document.querySelectorAll('details').forEach(function (d) { d.open = true; }); }
    if (id === 'collapseAll'){ document.querySelectorAll('details').forEach(function (d) { d.open = false; }); }
    if (id === 'viewByDay') { state.view = 'day'; render(); }
    if (id === 'viewByRoom'){ state.view = 'room'; render(); }
    if (id === 'downloadPdf') {
      e.preventDefault();
      const content = 'Programa (DEMO)\\n\\nSessões: ' + state.sessions.length + '\\nGerado em: ' + new Date().toLocaleString('pt-BR');
      const blob = new Blob([content], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'programa_demo.pdf';
      a.click();
      URL.revokeObjectURL(url);
    }
  });

  loadData();
</script>

</body>
</html>
